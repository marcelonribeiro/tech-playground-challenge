{% extends "base.html" %}

{% block content %}

<div class="row mb-4 align-items-center">
    <div class="col-12">
        <h2 class="fw-bold text-dark mb-0">Company Deep Dive</h2>
        <p class="text-muted mb-0">
            Analyzing organizational health by comparing
            <span class="fw-bold text-dark">Quantitative Metrics</span> (Survey Scores) against
            <span class="fw-bold text-primary">Qualitative Sentiment</span> (AI Analysis).
        </p>
    </div>
</div>

<div class="row g-4 mb-4">

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100 card-hover border-start border-4 border-info">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-bold">
                            Survey Participation
                            <i class="fas fa-question-circle info-icon" data-bs-toggle="tooltip" title="Percentage of employees who completed the survey. Higher participation increases data reliability."></i>
                        </h6>
                        <h2 class="mb-0 fw-bold display-5">{{ metrics.conversion_rate }}%</h2>
                    </div>
                    <div class="text-info bg-light rounded-circle p-2">
                        <i class="fas fa-bullhorn fa-lg"></i>
                    </div>
                </div>

                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ metrics.conversion_rate }}%"
                         aria-valuenow="{{ metrics.conversion_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <div class="d-flex justify-content-between small text-muted">
                    <span>{{ metrics.total_responses }} Responses</span>
                    <span>{{ metrics.total_invited }} Invited</span>
                </div>

                <div class="mt-4 p-2 bg-light rounded border border-light small text-secondary">
                    <i class="fas fa-lightbulb text-warning me-1"></i>
                    <strong>Insight:</strong>
                    {% if metrics.conversion_rate >= 70 %}
                        High participation! The data is highly representative of the company.
                    {% elif metrics.conversion_rate >= 50 %}
                        Moderate participation. Encourage more responses for better accuracy.
                    {% else %}
                        Low participation. Results may be skewed towards outliers.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100 card-hover border-start border-4 border-success">
            <div class="card-header bg-white border-0 pt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-uppercase small text-muted">Workforce Maturity (Tenure)</h6>
                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill">Distribution</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center h-100">
                    <div class="col-md-5 d-flex justify-content-center">
                        <div style="height: 250px; width: 100%;">
                            <canvas id="tenureChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-7 border-start-md ps-md-4 mt-3 mt-md-0">
                        <h5 class="fw-bold text-dark mb-2">Why this matters?</h5>
                        <p class="text-muted small mb-3">
                            A healthy organization balances <strong>New Talent</strong> (Innovation) with
                            <strong>Tenured Staff</strong> (Institutional Knowledge).
                        </p>

                        <ul class="list-unstyled small text-secondary">
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Juniors (<1y):</strong> Fresh perspectives, require onboarding.</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Mid-Level (1-5y):</strong> Core productivity engine.</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i><strong>Seniors (>5y):</strong> Culture carriers and mentors.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="fw-bold mb-0">Perception Gap Analysis</h5>
                    <p class="text-muted small mb-0">Detecting discrepancies between numerical scores and text sentiment.</p>
                </div>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#methodologyModal">
                    <i class="fas fa-info-circle me-1"></i> How to read this?
                </button>
            </div>
            <div class="card-body">
                <div class="row g-0">

                    <div class="col-lg-6 pe-lg-4 border-end-lg">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="fw-bold text-dark mb-0">1. User Reported Scores</h6>
                                <small class="text-muted">What they said (Explicit)</small>
                            </div>
                            <span class="badge bg-secondary">Scale: 0 - 10</span>
                        </div>

                        <div style="height: 350px;">
                            <canvas id="userRadarChart"></canvas>
                        </div>

                        <div class="mt-3 text-center small text-muted fst-italic">
                            "Direct responses to numerical survey questions."
                        </div>
                    </div>

                    <div class="col-lg-6 ps-lg-4 mt-4 mt-lg-0">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="fw-bold text-primary mb-0">2. AI Sentiment Analysis</h6>
                                <small class="text-muted">How they feel (Implicit)</small>
                            </div>
                            <span class="badge bg-primary">Scale: 1 - 5</span>
                        </div>

                        <div style="height: 350px;">
                            <canvas id="aiRadarChart"></canvas>
                        </div>

                        <div class="mt-3 text-center small text-muted fst-italic">
                            "Derived from open-text comments using NLP."
                        </div>
                    </div>

                </div>
            </div>
            <div class="card-footer bg-light p-3">
                <div class="d-flex align-items-start">
                    <i class="fas fa-search text-primary mt-1 me-2"></i>
                    <small class="text-muted">
                        <strong>Analysis Tip:</strong> Look for shapes that don't match.
                        If the <strong>Left Chart (User)</strong> shows high scores (edges) but the <strong>Right Chart (AI)</strong> shows low scores (center),
                        employees might be rating politely but venting frustrations in the comments (Silent Disengagement).
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="methodologyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Understanding the Gap</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>We compare two data sources to find the truth:</p>
                <hr>
                <h6 class="fw-bold text-secondary">Quantitative (0-10)</h6>
                <p class="small text-muted">Rational responses. Employees think about the number. Often inflated due to social desirability bias.</p>

                <h6 class="fw-bold text-primary">Qualitative (AI 1-5)</h6>
                <p class="small text-muted">Emotional responses. The NLP model extracts the sentiment from written comments. Often reveals the true "feeling" behind the score.</p>
            </div>
        </div>
    </div>
</div>

<script id="tenure-data" type="application/json">{{ charts.tenure | tojson }}</script>
<script id="ai-radar-data" type="application/json">{{ charts.ai_radar | tojson }}</script>
<script id="user-radar-data" type="application/json">{{ charts.user_radar | tojson }}</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- 1. Tenure Chart (Doughnut) ---
        const tenureCtx = document.getElementById('tenureChart');
        const tenureRaw = document.getElementById('tenure-data').textContent;

        if (tenureCtx && tenureRaw) {
            const tenureData = JSON.parse(tenureRaw);
            if (tenureData.labels.length > 0) {
                new Chart(tenureCtx, {
                    type: 'doughnut',
                    data: {
                        labels: tenureData.labels,
                        datasets: [{
                            data: tenureData.data,
                            backgroundColor: [
                                '#0dcaf0', // Cyan (Junior)
                                '#0d6efd', // Blue
                                '#6610f2', // Indigo
                                '#6f42c1', // Purple
                                '#d63384'  // Pink (Senior)
                            ],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { boxWidth: 12, usePointStyle: true, font: { size: 11 } }
                            }
                        },
                        layout: { padding: 10 }
                    }
                });
            }
        }

        // --- 2. User Radar Chart (Quantitative) ---
        const userCtx = document.getElementById('userRadarChart');
        const userRaw = document.getElementById('user-radar-data').textContent;

        if (userCtx && userRaw) {
            const userData = JSON.parse(userRaw);
            if (userData.labels.length > 0) {
                new Chart(userCtx, {
                    type: 'radar',
                    data: {
                        labels: userData.labels,
                        datasets: [{
                            label: 'Avg Score (0-10)',
                            data: userData.data,
                            backgroundColor: 'rgba(108, 117, 125, 0.2)',
                            borderColor: '#6c757d',
                            pointBackgroundColor: '#6c757d',
                            pointHoverBackgroundColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 10,
                                ticks: { stepSize: 2, display: false },
                                grid: { color: '#e9ecef' },
                                pointLabels: { font: { size: 11, weight: 'bold' }, color: '#495057' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // --- 3. AI Radar Chart (Qualitative) ---
        const aiCtx = document.getElementById('aiRadarChart');
        const aiRaw = document.getElementById('ai-radar-data').textContent;

        if (aiCtx && aiRaw) {
            const aiData = JSON.parse(aiRaw);
            if (aiData.labels.length > 0) {
                new Chart(aiCtx, {
                    type: 'radar',
                    data: {
                        labels: aiData.labels,
                        datasets: [{
                            label: 'Avg Sentiment (1-5)',
                            data: aiData.data,
                            backgroundColor: 'rgba(13, 110, 253, 0.2)',
                            borderColor: '#0d6efd',
                            pointBackgroundColor: '#0d6efd',
                            pointHoverBackgroundColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 5,
                                ticks: { stepSize: 1, display: false },
                                grid: { color: '#e9ecef' },
                                pointLabels: { font: { size: 11, weight: 'bold' }, color: '#0d6efd' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    });
</script>
{% endblock %}