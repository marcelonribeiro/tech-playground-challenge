{% extends "base.html" %}

{% block content %}

<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h2 class="fw-bold text-dark mb-0">Executive Overview</h2>
        <p class="text-muted mb-0">High-level metrics for <span class="fw-bold text-primary">{{ view_context }}</span></p>
    </div>
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-2">
                <form class="row g-2 align-items-center justify-content-end" onsubmit="event.preventDefault(); applyFilters();">
                    <div class="col-auto">
                        <span class="small text-uppercase fw-bold text-muted"><i class="fas fa-filter me-1"></i>Filter:</span>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm border-0 bg-light" id="departmentFilter" aria-label="Department Filter">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if selected_dept_id == dept.id %}selected{% endif %}>
                                {{ dept.name|title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <select class="form-select form-select-sm border-0 bg-light" id="roleFilter" aria-label="Role Filter">
                            <option value="">All Roles</option>
                            {% for role in roles %}
                            <option value="{{ role }}" {% if selected_role == role %}selected{% endif %}>
                                {{ role }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-primary btn-sm rounded-pill px-3" onclick="applyFilters()">
                            Apply
                        </button>
                        {% if selected_dept_id or selected_role %}
                        <a href="{{ url_for('web.index') }}" class="btn btn-link btn-sm text-muted text-decoration-none" title="Clear Filters">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if metrics.total_employees == 0 %}
<div class="row">
    <div class="col-12">
        <div class="empty-state shadow-sm mt-4">
            <div class="mb-3 text-secondary">
                <i class="fas fa-search fa-4x opacity-50"></i>
            </div>
            <h4 class="fw-bold">No Data Found</h4>
            <p class="text-muted">
                We couldn't find any employees matching the current filters.<br>
                Try clearing the filters or selecting a different department.
            </p>
            <a href="{{ url_for('web.index') }}" class="btn btn-outline-primary">
                Clear All Filters
            </a>
        </div>
    </div>
</div>
{% else %}

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 card-hover border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-bold">Active Headcount</h6>
                        <h2 class="mb-0 fw-bold display-6">{{ metrics.total_employees }}</h2>
                    </div>
                    <div class="text-primary bg-light rounded-circle p-2">
                        <i class="fas fa-users fa-lg"></i>
                    </div>
                </div>
                <div class="mt-3 small text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Total active employees in {{ view_context }}.
                </div>
            </div>
        </div>
    </div>

<div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 card-hover border-start border-4 border-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-bold">
                            Avg Feedback Score
                            <i class="fas fa-question-circle info-icon" data-bs-toggle="tooltip"
                               title="Average score (1-10) given by employees regarding the feedback culture."></i>
                        </h6>
                        <h2 class="mb-0 fw-bold display-6">{{ metrics.avg_feedback }}</h2>
                    </div>
                    <div class="text-warning bg-light rounded-circle p-2">
                        <i class="fas fa-star fa-lg"></i>
                    </div>
                </div>
                <div class="mt-3 small text-muted">
                    Scale from 1 (Poor) to 10 (Excellent).
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 card-hover border-start border-4
            {% if metrics.enps >= 50 %}border-success{% elif metrics.enps >= 0 %}border-warning{% else %}border-danger{% endif %}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-muted text-uppercase mb-1 small fw-bold">
                            eNPS Score
                            <i class="fas fa-question-circle info-icon" data-bs-toggle="tooltip" title="Employee Net Promoter Score = % Promoters - % Detractors. Range: -100 to +100."></i>
                        </h6>
                        <h2 class="mb-0 fw-bold display-6">{{ metrics.enps }}</h2>
                    </div>
                    <div class="{% if metrics.enps >= 0 %}text-success{% else %}text-danger{% endif %} bg-light rounded-circle p-2">
                        <i class="fas fa-heart fa-lg"></i>
                    </div>
                </div>

                <div class="mt-3 small">
                    {% if metrics.enps >= 50 %}
                        <span class="badge bg-success bg-opacity-10 text-success px-2 py-1">Excellent</span>
                    {% elif metrics.enps >= 0 %}
                        <span class="badge bg-warning bg-opacity-10 text-warning px-2 py-1">Good</span>
                    {% else %}
                        <span class="badge bg-danger bg-opacity-10 text-danger px-2 py-1">Needs Attention</span>
                    {% endif %}
                    <span class="text-muted ms-1">Zone</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="fw-bold mb-0">Department Distribution</h5>
                    <p class="text-muted small mb-0">Headcount breakdown by area to identify hiring needs.</p>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
            <div class="card-body px-4 pb-4">
                <div style="height: 350px;">
                    <canvas id="deptDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="dashboard-data" type="application/json">
    {{ chart_data.data | tojson }}
</script>
<script id="dashboard-labels" type="application/json">
    {{ chart_data.labels | tojson }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart Initialization
        const ctx = document.getElementById('deptDistributionChart');
        const rawData = document.getElementById('dashboard-data').textContent;
        const rawLabels = document.getElementById('dashboard-labels').textContent;

        if (ctx && rawData && rawLabels) {
            const chartValues = JSON.parse(rawData);
            const chartLabels = JSON.parse(rawLabels);

            if (chartLabels.length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Headcount',
                            data: chartValues,
                            backgroundColor: 'rgba(13, 110, 253, 0.8)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 0,
                            borderRadius: 6,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#212529',
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { borderDash: [4, 4], color: '#e9ecef' },
                                ticks: { font: { size: 11 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11, weight: 'bold' } }
                            }
                        }
                    }
                });
            }
        }
    });

    function applyFilters() {
        const deptId = document.getElementById('departmentFilter').value;
        const role = document.getElementById('roleFilter').value;
        const currentUrl = new URL(window.location.href);

        if (deptId) currentUrl.searchParams.set('dept_id', deptId);
        else currentUrl.searchParams.delete('dept_id');

        if (role) currentUrl.searchParams.set('role', role);
        else currentUrl.searchParams.delete('role');

        window.location.href = currentUrl.toString();
    }
</script>

{% endif %} {% endblock %}